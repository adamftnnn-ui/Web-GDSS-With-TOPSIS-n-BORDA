<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GDSS - Laporan Akhir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#2563EB',
                        'primary-light': '#EFF6FF',
                    },
                    fontSize: {
                        'xs': '.75rem',
                        'sm': '.875rem',
                        'base': '1rem',
                        'lg': '1.125rem',
                        'xl': '1.25rem',
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="alert.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>

<body class="min-h-screen bg-gray-50 flex text-sm antialiased">
    <aside class="w-56 bg-white shadow-lg flex flex-col px-4 py-5 space-y-6 border-r border-gray-100 h-screen">
        <div class="flex items-center space-x-2">
            <div class="h-8 w-8 bg-primary rounded-lg flex items-center justify-center text-white font-bold text-lg">
                G
            </div>
            <h2 class="text-lg font-bold text-gray-800 tracking-tight">GDSS</h2>
        </div>

        <nav class="flex flex-col space-y-1">
            <a href="dashboard.html"
                class="flex items-center gap-2 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 hover:text-gray-900 transition">
                <i data-feather="home" class="w-4"></i>
                <span>Dashboard</span>
            </a>
            <a href="data-decision-maker.html"
                class="flex items-center gap-2 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 hover:text-gray-900 transition">
                <i data-feather="user-check" class="w-4"></i>
                <span>Data Decision Maker</span>
            </a>
            <a href="data-alternatif.html"
                class="flex items-center gap-2 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 hover:text-gray-900 transition">
                <i data-feather="folder" class="w-4"></i>
                <span>Data Alternatif</span>
            </a>
            <a href="data-kriteria.html"
                class="flex items-center gap-2 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 hover:text-gray-900 transition">
                <i data-feather="sliders" class="w-4"></i>
                <span>Data Kriteria</span>
            </a>
            <a href="form-penilaian.html"
                class="flex items-center gap-2 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 hover:text-gray-900 transition">
                <i data-feather="edit-3" class="w-4"></i>
                <span>Form Penilaian</span>
            </a>
            <a href="hasil-individu.html"
                class="flex items-center gap-2 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 hover:text-gray-900 transition">
                <i data-feather="bar-chart-2" class="w-4"></i>
                <span>Hasil Individu</span>
            </a>
            <a href="hasil-kelompok.html"
                class="flex items-center gap-2 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 hover:text-gray-900 transition">
                <i data-feather="users" class="w-4"></i>
                <span>Hasil Kelompok</span>
            </a>
            <a href="#"
                class="flex items-center gap-2 px-3 py-2 rounded-lg bg-primary-light text-primary font-medium transition">
                <i data-feather="file-text" class="w-4"></i>
                <span>Laporan</span>
            </a>
        </nav>

        <div class="mt-auto border-t pt-4 border-gray-100">
            <nav class="flex flex-col space-y-1">
                <a href="profil.html"
                    class="flex items-center gap-2 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 hover:text-gray-900 transition">
                    <i data-feather="user" class="w-4"></i>
                    <span>Profil Saya</span>
                </a>
                <a href="index.html"
                    class="flex items-center gap-2 px-3 py-2 rounded-lg text-red-600 hover:bg-red-50 transition">
                    <i data-feather="log-out" class="w-4"></i>
                    <span>Logout</span>
                </a>
            </nav>
        </div>
    </aside>

    <main class="flex-1 px-8 py-6 space-y-6 overflow-y-auto h-screen">
        <header class="flex items-center justify-between pb-4 border-b border-gray-200">
            <h1 class="text-xl font-bold text-gray-900 tracking-tight">
                Laporan Akhir Keputusan (TOPSIS & BORDA)
            </h1>
            <div class="flex gap-3">
                <!-- <button id="btnExportExcel"
                    class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 active:scale-[0.98] text-sm font-medium">
                    <i data-feather="file-text" class="w-4 h-4"></i>
                    <span>Export Excel</span> -->
                </button>
                <button id="btnExportPDF"
                    class="flex items-center gap-2 bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 active:scale-[0.98] text-sm font-medium">
                    <i data-feather="file" class="w-4 h-4"></i>
                    <span>Export PDF</span>
                </button>
            </div>
        </header>

        <div id="loadingContainer">
            <section class="bg-white p-6 rounded-xl shadow-md border border-gray-100">
                <p class="text-center text-gray-500 py-8">
                    <i data-feather="loader" class="w-6 h-6 animate-spin inline-block"></i>
                    <span class="ml-2">Memuat laporan akhir...</span>
                </p>
            </section>
        </div>

        <div id="hasilContainer" class="hidden space-y-6">
            <section class="bg-white p-6 rounded-xl shadow-md border border-gray-100">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Informasi Decision Maker</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-separate border-spacing-y-2 text-sm">
                        <thead class="text-gray-600 text-xs uppercase tracking-wider">
                            <tr>
                                <th class="px-4 py-2">Decision Maker</th>
                                <th class="px-4 py-2">Jumlah Alternatif</th>
                                <th class="px-4 py-2">Jumlah Kriteria</th>
                                <th class="px-4 py-2">Tanggal Penilaian</th>
                            </tr>
                        </thead>
                        <tbody id="infoDmTableBody" class="text-gray-700">
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="bg-white p-6 rounded-xl shadow-md border border-gray-100">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Ringkasan Hasil Individu (Ranking TOPSIS per DM)
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-separate border-spacing-y-2 text-sm">
                        <thead id="rankingDmTableHead" class="text-gray-600 text-xs uppercase tracking-wider">
                        </thead>
                        <tbody id="rankingDmTableBody" class="text-gray-700">
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="bg-white p-6 rounded-xl shadow-md border border-gray-100">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Rekapitulasi Poin BORDA dari Seluruh Decision Maker
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-separate border-spacing-y-2 text-sm">
                        <thead id="skorBordaTableHead" class="text-gray-600 text-xs uppercase tracking-wider">
                        </thead>
                        <tbody id="skorBordaTableBody" class="text-gray-700">
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="bg-white p-6 rounded-xl shadow-md border border-gray-100">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Visualisasi Hasil Akhir BORDA</h2>
                <div id="bordaChartContainer"
                    class="w-full h-64 rounded-lg flex items-center justify-center text-gray-400 text-sm">
                </div>
                <p class="text-sm text-gray-500 mt-3 leading-relaxed">
                    Visualisasi ini akan menampilkan total poin <strong>BORDA</strong> dari setiap alternatif yang
                    dihitung
                    sebagai hasil
                    akhir kelompok.
                </p>
            </section>

            <section class="bg-white p-6 rounded-xl shadow-md border border-gray-100">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Kesimpulan</h2>
                <p id="kesimpulanText" class="text-gray-700 leading-relaxed">
                </p>
                <p id="tanggalLaporan" class="text-xs text-gray-500 mt-4">
                </p>
            </section>
        </div>

        <div class="h-10"></div>
    </main>

    <script>
        feather.replace();
        // const btnExportExcel = document.getElementById('btnExportExcel');
        const btnExportPDF = document.getElementById('btnExportPDF');

        // Helper untuk memformat angka dengan pemisah ribuan (IDR format)
        const formatNumber = (num, decimals = 4) => {
            if (typeof num !== 'number' || isNaN(num)) return 'N/A';
            return num.toLocaleString('id-ID', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        };

        // btnExportExcel.addEventListener('click', () => {
        //     showAlert('Data **Laporan Akhir** berhasil diexport ke Excel.', 'success');
        // });

        btnExportPDF.addEventListener('click', async () => {
            btnExportPDF.disabled = true;
            const originalHTML = btnExportPDF.innerHTML;
            btnExportPDF.innerHTML = '<i data-feather="loader" class="w-4 h-4 animate-spin"></i> Mengunduh…';
            feather.replace();

            try {
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) throw new Error('Token tidak tersedia, silakan login kembali.');

                const [laporanData, bordaResponse] = await Promise.all([
                    fetch('https://web-gdss.vercel.app/api/penilaian/laporan', { headers: { 'Authorization': `Bearer ${accessToken}` } }).then(r => r.json()),
                    fetch('https://web-gdss.vercel.app/api/penilaian/borda', { headers: { 'Authorization': `Bearer ${accessToken}` } }).then(r => r.json())
                ]);

                // ===================================================
                // === PEMROSESAN DATA UTAMA ===
                // ===================================================
                const rankingData = bordaResponse[0]?.ranking_alternatif_per_decision_maker || [];
                const bordaRaw = bordaResponse[0]?.perhitungan_skor_borda || [];

                if (rankingData.length === 0 || bordaRaw.length === 0) {
                    throw new Error("Data Ranking atau Borda tidak lengkap untuk membuat laporan.");
                }

                const dmHeaders = rankingData.map(dmObj => Object.keys(dmObj)[0]);
                const altNames = Object.keys(rankingData[0][dmHeaders[0]]);
                const m = altNames.length; // Jumlah Alternatif

                const bordaDataProcessed = bordaRaw.map(item => {
                    const altName = Object.keys(item)[0];
                    const values = item[altName];
                    return { nama: altName, total_skor: values.skor_akhir, peringkat: values.ranking };
                }).sort((a, b) => a.peringkat - b.peringkat);
                // ===================================================

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 50;
                const headerHeight = 30; // Jarak total header dari atas
                let y = margin;
                let pageNum = 1;

                // --- Style Korporat ---
                const corporateBlue = [10, 39, 85];
                const accentRed = [200, 30, 50];
                const darkGrey = [50, 50, 50];
                const lightGrey = [238, 238, 238];

                // --- Fungsi Header dan Footer Formal ---
                function addHeader(doc, pageNum, sectionTitle) {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(corporateBlue[0], corporateBlue[1], corporateBlue[2]);
                    doc.text("GDSS: Laporan Analisis Keputusan", margin, margin);

                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(sectionTitle, pageWidth / 2, margin, { align: 'center' });

                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(darkGrey[0], darkGrey[1], darkGrey[2]);
                    doc.text(`Halaman ${pageNum}`, pageWidth - margin, margin, { align: 'right' });

                    doc.setDrawColor(corporateBlue[0], corporateBlue[1], corporateBlue[2]);
                    doc.setLineWidth(1.5);
                    doc.line(margin, margin + 12, pageWidth - margin, margin + 12);
                }

                function addFooter(doc) {
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    const currentYear = new Date().getFullYear();
                    doc.text(`Hak Cipta © ${currentYear} | GDSS Analytic Platform`, margin, pageHeight - 30);
                }
                // --------------------------------

                // --- 0. Halaman Judul (Executive Cover) ---
                doc.setFontSize(16);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(darkGrey[0], darkGrey[1], darkGrey[2]);
                doc.text("Laporan Akhir", pageWidth / 2, pageHeight / 3 - 20, { align: 'center' });

                doc.setFontSize(40);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(corporateBlue[0], corporateBlue[1], corporateBlue[2]);
                doc.text("ANALISIS KEPUTUSAN", pageWidth / 2, pageHeight / 3 + 30, { align: 'center' });

                doc.setFontSize(18);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(accentRed[0], accentRed[1], accentRed[2]);
                doc.text("Berdasarkan Konsensus TOPSIS & BORDA", pageWidth / 2, pageHeight / 3 + 60, { align: 'center' });

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100);
                const coverDate = new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
                doc.text(`Dokumen Dibuat: ${coverDate}`, pageWidth / 2, pageHeight - 100, { align: 'center' });

                doc.addPage();
                y = margin + headerHeight;

                // --- Konten Halaman 2 dan seterusnya ---
                addHeader(doc, pageNum, "Informasi Partisipan");

                function checkPageBreak(doc, currentY, minSpace = 60, sectionTitle) {
                    if (currentY + minSpace > pageHeight - margin - 30) {
                        addFooter(doc);
                        doc.addPage();
                        pageNum++;
                        addHeader(doc, pageNum, sectionTitle);
                        currentY = margin + headerHeight;
                    }
                    return currentY;
                }

                // --- Bagian 1: Executive Summary ---
                y = checkPageBreak(doc, y, 100, "Ringkasan Eksekutif");
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(corporateBlue[0], corporateBlue[1], corporateBlue[2]);
                doc.text("1. Ringkasan", margin, y);
                y += 20;

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(darkGrey[0], darkGrey[1], darkGrey[2]);

                if (bordaDataProcessed.length > 0) {
                    const pemenang = bordaDataProcessed.filter(item => item.peringkat === 1);
                    const namaPemenang = pemenang.map(i => `${i.nama}`).join(' / ');
                    const skorTertinggi = formatNumber(pemenang[0].total_skor);

                    // TEKS TELAH DIMODIFIKASI UNTUK MENGHILANGKAN BOLD PADA PARAGRAF DAN MENGGUNAKAN RATA KIRI
                    let decisionLine = `KEPUTUSAN: ${namaPemenang}`;

                    let summaryText = `Analisis ini melibatkan ${laporanData.length} Decision Maker dan bertujuan memberikan rekomendasi keputusan yang optimal. Setelah melalui proses penilaian individu menggunakan TOPSIS, hasil dikonsolidasikan menggunakan Metode BORDA. Hasil akhir secara mutlak merekomendasikan ${namaPemenang} sebagai alternatif terbaik dengan total skor konsensus ${skorTertinggi}. Keputusan ini mencerminkan penerimaan yang paling tinggi dan stabil di seluruh grup partisipan.`;

                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(accentRed[0], accentRed[1], accentRed[2]);
                    doc.text(decisionLine, margin, y);
                    y += 15;

                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(darkGrey[0], darkGrey[1], darkGrey[2]);

                    // Menggunakan doc.splitTextToSize yang menghasilkan alignment RATA KIRI (Left Justify) yang rapi
                    const splitText = doc.splitTextToSize(summaryText, pageWidth - 2 * margin);
                    doc.text(splitText, margin, y);
                    y += splitText.length * 15;
                } else {
                    doc.text("Data hasil analisis belum lengkap untuk menghasilkan Executive Summary.", margin, y);
                    y += 15;
                }

                // --- Bagian 2: Data Partisipan & Status ---
                y = checkPageBreak(doc, y, 100, "Data Partisipan");
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(corporateBlue[0], corporateBlue[1], corporateBlue[2]);
                doc.text("2. Data Partisipan", margin, y);
                y += 20;

                const dmTableBody = laporanData.map(dm => [
                    dm.peran,
                    dm.total_alternatif,
                    dm.total_kriteria,
                    dm.tanggal_penilaian ? new Date(dm.tanggal_penilaian).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) : 'Pending'
                ]);

                doc.autoTable({
                    startY: y,
                    head: [['Partisipan (Decision Maker)', 'Jml. Alternatif', 'Jml. Kriteria', 'Status Penilaian']],
                    body: dmTableBody,
                    styles: { fontSize: 10, cellPadding: 8, lineColor: lightGrey, lineWidth: 0.1, textColor: darkGrey },
                    columnStyles: {
                        0: { halign: 'left', fontStyle: 'bold' },
                        1: { halign: 'center' },
                        2: { halign: 'center' },
                        3: { halign: 'center' }
                    },
                    theme: 'plain',
                    headStyles: { fillColor: corporateBlue, textColor: 255, fontStyle: 'bold', minCellHeight: 25 },
                    alternateRowStyles: { fillColor: lightGrey },
                    margin: { left: margin, right: margin }
                });

                pageNum = doc.internal.pages.length;
                y = doc.lastAutoTable.finalY + 30;

                // --- Bagian 3: Konsolidasi Ranking Individu ---
                y = checkPageBreak(doc, y, 100, "Konsolidasi Ranking");
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(corporateBlue[0], corporateBlue[1], corporateBlue[2]);
                doc.text("3. Konsolidasi Ranking Individu (TOPSIS)", margin, y);
                y += 20;

                const rankingTableBody = altNames.map(alt => [alt, ...dmHeaders.map(dm => rankingData.find(d => d[dm])?.[dm]?.[alt] || 'N/A')]);

                doc.autoTable({
                    startY: y,
                    head: [['Alternatif', ...dmHeaders.map(dm => `Rank ${dm}`)]],
                    body: rankingTableBody,
                    styles: { fontSize: 10, cellPadding: 8, halign: 'center', lineColor: lightGrey, lineWidth: 0.1, textColor: darkGrey },
                    columnStyles: { 0: { halign: 'left', fontStyle: 'bold' } },
                    theme: 'plain',
                    headStyles: { fillColor: corporateBlue, textColor: 255, fontStyle: 'bold', minCellHeight: 25 },
                    alternateRowStyles: { fillColor: lightGrey },
                    margin: { left: margin, right: margin }
                });

                pageNum = doc.internal.pages.length;
                y = doc.lastAutoTable.finalY + 30;

                // --- Bagian 4: Hasil Akhir (Metode BORDA) ---
                y = checkPageBreak(doc, y, 100, "Hasil Akhir & Keputusan");
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(corporateBlue[0], corporateBlue[1], corporateBlue[2]);
                doc.text("4. Hasil Akhir (BORDA)", margin, y);
                y += 20;

                const bordaTableBody = bordaDataProcessed.map(item => {
                    const row = [item.nama];
                    dmHeaders.forEach((dmName, idx) => {
                        const rankData = rankingData.find(d => d[dmName]);
                        if (rankData) {
                            const rank = rankData[dmName][item.nama];
                            const score = (m - rank);
                            row.push(score.toString());
                        } else {
                            row.push('0');
                        }
                    });
                    row.push(formatNumber(item.total_skor), item.peringkat.toString());
                    return row;
                });

                const bordaHead = [['Alternatif', ...dmHeaders.map(dm => `Skor (${dm})`), 'TOTAL SKOR', 'PERINGKAT']];

                const columnStylesConfig = { 0: { halign: 'left', fontStyle: 'bold' } };
                for (let i = 1; i < bordaHead[0].length - 1; i++) {
                    columnStylesConfig[i] = { halign: 'right' };
                }
                columnStylesConfig[bordaHead[0].length - 1] = { halign: 'center', fontStyle: 'bold' };

                const bodyStyles = bordaDataProcessed.map(item => {
                    if (item.peringkat === 1) {
                        return { fillColor: accentRed, textColor: 255, fontStyle: 'bold' };
                    }
                    return {};
                });

                doc.autoTable({
                    startY: y,
                    head: bordaHead,
                    body: bordaTableBody,
                    styles: { fontSize: 10, cellPadding: 8, lineColor: lightGrey, lineWidth: 0.1, textColor: darkGrey },
                    bodyStyles: bodyStyles,
                    columnStyles: columnStylesConfig,
                    theme: 'plain',
                    headStyles: { fillColor: corporateBlue, textColor: 255, fontStyle: 'bold', minCellHeight: 25 },
                    alternateRowStyles: { fillColor: lightGrey },
                    margin: { left: margin, right: margin }
                });

                addFooter(doc);

                doc.save(`Laporan_Keputusan_Korporat_${new Date().toISOString().split('T')[0]}.pdf`);

            } catch (error) {
                alert('Gagal export PDF: ' + error.message);
                console.error(error);
            } finally {
                btnExportPDF.disabled = false;
                btnExportPDF.innerHTML = originalHTML;
                feather.replace();
            }
        });
    </script>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const accessToken = localStorage.getItem('accessToken');
            const currentUser = parseJwt(accessToken);
            const isAdmin = currentUser?.peran === 'Admin';

            function parseJwt(token) {
                if (!token) return null;
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            }

            const loadingContainer = document.getElementById('loadingContainer');
            const hasilContainer = document.getElementById('hasilContainer');

            if (!accessToken) {
                localStorage.removeItem("accessToken");
                window.location.href = "index.html";
                return;
            }

            const formPenilaian = document.querySelector('a[href="form-penilaian.html"]');
            const hasilIndividu = document.querySelector('a[href="hasil-individu.html"]');
            const dataKriteria = document.querySelector('a[href="data-kriteria.html"]');
            if (isAdmin && formPenilaian && hasilIndividu) {
                formPenilaian.remove();
                hasilIndividu.remove();
            }
            if (!isAdmin && dataKriteria) {
                dataKriteria.remove();
            }

            const API_PROD_URL = 'https://web-gdss.vercel.app/api';
            const LOGOUT_URL = `${API_PROD_URL}/auth/logout`;
            const LAPORAN_URL = `${API_PROD_URL}/penilaian/laporan`;
            const BORDA_URL = `${API_PROD_URL}/penilaian/borda`;

            async function fetchWithToken(url, options = {}) {
                const headers = { 'Authorization': `Bearer ${accessToken}` };
                if (options.body) {
                    headers['Content-Type'] = 'application/json';
                }
                const config = { ...options, headers: { ...headers, ...options.headers } };

                const response = await fetch(url, config);
                if (response.status === 401 || response.status === 403) throw new Error('Unauthorized');

                const text = await response.text();
                if (!text) {
                    if (!response.ok) throw new Error(`API Error: ${response.statusText} (No Content)`);
                    return null;
                }

                let data;
                try { data = JSON.parse(text); }
                catch (e) {
                    console.error("Gagal parse JSON:", text);
                    throw new Error("Respons server bukan JSON yang valid.");
                }

                if (!response.ok) {
                    const errorMessage = data.message || data.error || `API Error: ${response.statusText}`;
                    throw new Error(errorMessage);
                }
                return data;
            }

            async function forceLogout() {
                localStorage.removeItem('accessToken');
                window.location.href = 'index.html';
            }

            const logoutButton = document.querySelector('nav a[href="index.html"]');
            logoutButton.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    await fetch(LOGOUT_URL, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                } catch (error) {
                    console.warn("Panggilan API Logout gagal, logout secara lokal.", error);
                } finally {
                    forceLogout();
                }
            });
            const TANGGAL_LAPORAN_STRING = new Date().toLocaleDateString('id-ID', {
                day: '2-digit', month: 'long', year: 'numeric'
            });
            function renderInfoTable(laporanData) {
                const tbody = document.getElementById('infoDmTableBody');
                tbody.innerHTML = '';

                if (!laporanData || laporanData.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">Belum ada Decision Maker yang melakukan penilaian.</td></tr>`;
                    return;
                }

                laporanData.forEach(dm => {
                    const tanggal = dm.tanggal_penilaian
                        ? new Date(dm.tanggal_penilaian).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })
                        : '<span class="text-gray-400">Belum Menilai</span>';

                    tbody.innerHTML += `
                        <tr class="bg-gray-50 hover:bg-blue-50 transition-all">
                            <td class="px-4 py-3 font-medium rounded-l-lg">${dm.peran}</td>
                            <td class="px-4 py-3">${dm.total_alternatif}</td>
                            <td class="px-4 py-3">${dm.total_kriteria}</td>
                            <td class="px-4 py-3 rounded-r-lg">${tanggal}</td>
                        </tr>
                    `;
                });
            }
            function renderRankingDM(rankingData, dmHeaders, altNames) {
                const thead = document.getElementById('rankingDmTableHead');
                const tbody = document.getElementById('rankingDmTableBody');

                let headHTML = '<tr><th class="px-4 py-2">Alternatif</th>';
                dmHeaders.forEach(h => {
                    headHTML += `<th class="px-4 py-2 text-center">${h}</th>`;
                });
                headHTML += '</tr>';
                thead.innerHTML = headHTML;

                let bodyHTML = '';
                altNames.forEach(altName => {
                    bodyHTML += `<tr class="bg-gray-50 hover:bg-blue-50 transition-all">
                        <td class="px-4 py-3 font-medium rounded-l-lg">${altName}</td>`;

                    dmHeaders.forEach((dmName, index) => {
                        const rank = rankingData[index][dmName][altName] || 'N/A';
                        bodyHTML += `<td class="px-4 py-3 text-center">${rank}</td>`;
                    });

                    bodyHTML += `<td class="rounded-r-lg"></td></tr>`;
                });
                tbody.innerHTML = bodyHTML || `<tr><td colspan="${dmHeaders.length + 1}" class="text-center p-4 text-gray-500">Data ranking tidak tersedia.</td></tr>`;
            }
            function renderSkorBorda(rankingData, bordaData, dmHeaders, m) {
                const thead = document.getElementById('skorBordaTableHead');
                const tbody = document.getElementById('skorBordaTableBody');

                let headHTML = '<tr><th class="px-4 py-2">Alternatif</th>';
                dmHeaders.forEach(h => {
                    headHTML += `<th class="px-4 py-2 text-center">Skor ${h}</th>`;
                });
                headHTML += `<th class="px-4 py-2 text-center">Total Skor</th>
                             <th class="px-4 py-2 text-center">Peringkat</th></tr>`;
                thead.innerHTML = headHTML;

                let bodyHTML = '';

                bordaData.forEach(item => {
                    const isWinner = item.peringkat === 1;
                    const rowClass = isWinner ? "bg-primary-light hover:bg-blue-100" : "bg-gray-50 hover:bg-blue-50";
                    const textClass = isWinner ? "font-bold text-primary" : "font-semibold";

                    bodyHTML += `<tr class="${rowClass} transition-all">
                        <td class="px-4 py-3 rounded-l-lg font-medium">${item.nama}</td>`;

                    dmHeaders.forEach((dmName, index) => {
                        if (rankingData[index] && rankingData[index][dmName]) {
                            const rank = rankingData[index][dmName][item.nama];
                            const score = (m - rank) + 1;
                            bodyHTML += `<td class="px-4 py-3 text-center">${score || 'N/A'}</td>`;
                        } else {
                            bodyHTML += `<td class="px-4 py-3 text-center">N/A</td>`;
                        }
                    });

                    bodyHTML += `<td class="px-4 py-3 text-center ${textClass}">${item.total_skor.toFixed(4)}</td>
                                 <td class="px-4 py-3 text-center rounded-r-lg ${textClass}">${item.peringkat}</td>
                                 </tr>`;
                });
                tbody.innerHTML = bodyHTML || `<tr><td colspan="${dmHeaders.length + 3}" class="text-center p-4 text-gray-500">Data skor tidak tersedia.</td></tr>`;
            }
            function renderBordaChart(bordaData) {
                const container = document.getElementById('bordaChartContainer');
                container.innerHTML = '<canvas id="bordaChartCanvas"></canvas>';
                container.classList.remove('bg-gray-100');

                const ctx = document.getElementById('bordaChartCanvas').getContext('2d');

                const sortedData = [...bordaData].sort((a, b) => b.total_skor - a.total_skor);
                const labels = sortedData.map(item => item.nama);
                const scores = sortedData.map(item => item.total_skor);

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Skor BORDA',
                            data: scores,
                            backgroundColor: 'rgba(37, 99, 235, 0.6)',
                            borderColor: 'rgba(37, 99, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: { x: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
            function renderKesimpulan(bordaData, dmCount) {
                const p = document.getElementById('kesimpulanText');
                const tgl = document.getElementById('tanggalLaporan');

                if (!bordaData || bordaData.length === 0) {
                    p.innerHTML = 'Data perhitungan tidak tersedia.';
                    return;
                }

                const skorTertinggi = Math.max(...bordaData.map(item => item.total_skor));
                const pemenang = bordaData.filter(item => item.total_skor === skorTertinggi);
                const namaPemenang = pemenang.map(item => `<strong>${item.nama}</strong>`).join(' dan ');

                const skorLain = bordaData.filter(item => item.total_skor < skorTertinggi);
                let runnerUpText = '';
                if (skorLain.length > 0) {
                    const skorRunnerUp = Math.max(...skorLain.map(item => item.total_skor));
                    const runnerUp = skorLain.filter(item => item.total_skor === skorRunnerUp);
                    const namaRunnerUp = runnerUp.map(item => `<strong>${item.nama}</strong>`).join(' dan ');
                    runnerUpText = `, diikuti oleh ${namaRunnerUp} dengan total ${skorRunnerUp.toFixed(4)} poin`;
                }

                p.innerHTML = `
                    Berdasarkan hasil penggabungan metode <strong>TOPSIS</strong> (untuk ranking individu) dan <strong>BORDA</strong> (untuk agregasi kelompok) dari <strong>${dmCount} Decision Maker</strong> yang telah melakukan penilaian,
                    ${pemenang.length > 1 ? 'terdapat <strong>' + pemenang.length + ' alternatif terbaik</strong>' : 'alternatif terbaik'}
                    wisata kuliner kelompok adalah ${namaPemenang}
                    yang ${pemenang.length > 1 ? 'sama-sama mendapatkan' : 'mendapatkan'}
                    total skor tertinggi (<strong>${skorTertinggi.toFixed(4)} poin</strong>)${runnerUpText}.
                `;

                tgl.textContent = `Laporan dihasilkan secara otomatis oleh sistem GDSS pada ${TANGGAL_LAPORAN_STRING}.`;
            }
            async function loadLaporanData() {
                try {
                    const [bordaResponse, laporanData] = await Promise.all([
                        fetchWithToken(BORDA_URL),
                        fetchWithToken(LAPORAN_URL)
                    ]);

                    console.log("Data Borda:", bordaResponse);
                    console.log("Data Laporan DM:", laporanData);

                    if (!bordaResponse || !Array.isArray(bordaResponse) || bordaResponse.length === 0 || !bordaResponse[0].ranking_alternatif_per_decision_maker || !bordaResponse[0].perhitungan_skor_borda) {
                        loadingContainer.innerHTML = `<section class="bg-white p-6 rounded-xl shadow-md border border-gray-100"><p class="text-center text-gray-500 py-8">Belum ada data penilaian yang cukup untuk dihitung (BORDA).</p></section>`;
                        if (laporanData) {
                            renderInfoTable(laporanData);
                            hasilContainer.style.display = 'block';
                        }
                        return;
                    }
                    if (!laporanData || !Array.isArray(laporanData)) {
                        throw new Error("Data Laporan Decision Maker tidak valid.");
                    }

                    const payload = bordaResponse[0];

                    const rankingData = payload.ranking_alternatif_per_decision_maker;
                    const bordaDataRaw = payload.perhitungan_skor_borda;
                    const dmHeaders = rankingData.map(dmObj => Object.keys(dmObj)[0]);
                    const altNames = Object.keys(rankingData[0][dmHeaders[0]]);
                    const m = altNames.length;

                    const bordaDataProcessed = bordaDataRaw.map(item => {
                        const altName = Object.keys(item)[0];
                        const values = item[altName];
                        return {
                            nama: altName,
                            total_skor: values.skor_akhir,
                            peringkat: values.ranking
                        };
                    }).sort((a, b) => a.peringkat - b.peringkat);

                    renderInfoTable(laporanData);
                    renderRankingDM(rankingData, dmHeaders, altNames);
                    renderSkorBorda(rankingData, bordaDataProcessed, dmHeaders, m);
                    renderBordaChart(bordaDataProcessed);
                    renderKesimpulan(bordaDataProcessed, dmHeaders.length);

                    loadingContainer.style.display = 'none';
                    hasilContainer.style.display = 'block';
                    feather.replace();

                } catch (error) {
                    console.error('Gagal memuat Laporan:', error);
                    let errorMsg = `Gagal memuat hasil: ${error.message}`;
                    if (error.message === 'Unauthorized') {
                        errorMsg = "Sesi Anda telah berakhir. Harap login kembali.";
                        forceLogout();
                    }
                    loadingContainer.innerHTML = `<section class="bg-white p-6 rounded-xl shadow-md border border-gray-100"><p class="text-center text-red-500 py-8">${errorMsg}</p></section>`;
                }
            }
            loadLaporanData();
        });
    </script>
</body>

</html>